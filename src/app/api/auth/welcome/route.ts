import { NextRequest, NextResponse } from 'next/server';\nimport { createSupabaseServerClient } from '@/lib/supabase-server';\nimport { sendWelcomeEmail } from '@/lib/welcome-email';\n\nexport async function POST(request: NextRequest) {\n  const supabase = createSupabaseServerClient();\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user?.email) {\n    return NextResponse.json({ error: 'No user' }, { status: 401 });\n  }\n\n  // Check if welcome email already sent, handle missing column gracefully\n  let alreadySent = false;\n  try {\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('welcome_email_sent')\n      .eq('id', user.id)\n      .single();\n\n    if (profile?.welcome_email_sent) {\n      alreadySent = true;\n    }\n  } catch (checkError) {\n    console.warn('Welcome email check failed (likely missing column):', checkError);\n    // Proceed to send as new user\n  }\n\n  if (alreadySent) {\n    return NextResponse.json({ already_sent: true });\n  }\n\n  try {\n    await sendWelcomeEmail(user.email, user.user_metadata?.full_name);\n\n    // Mark as sent, ignore if column missing\n    await supabase\n      .from('profiles')\n      .upsert({ \n        id: user.id, \n        welcome_email_sent: true \n      }, { onConflict: 'id' });\n\n    return NextResponse.json({ sent: true });\n  } catch (error) {\n    console.error('Welcome email error:', error);\n    return NextResponse.json({ error: 'Failed to send' }, { status: 500 });\n  }\n}