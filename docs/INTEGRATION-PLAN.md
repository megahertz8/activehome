# Integration Plan: Energy Skills → Evolving Home\n\nThis plan outlines how to integrate concepts from **Smart Home Energy Saver** (HA integration) and **AfrexAI Energy Audit** (EUI, expanded ECMs, financial modeling, phased roadmap, grants, benchmarking) into the existing Evolving Home app.\n\nCurrent codebase analysis:\n- `roi-calculator.ts`: Solar + HP payback only (tariff-aware).\n- `energy-calc.ts`: SAP/OpenBEM + EPC → heat loss, upgrades (wall/roof/floor/window/vent with basic payback).\n- `score/ScoreResults.tsx`: Displays ratings, costs, solar, heat loss pie—no EUI/roadmap.\n- `roi/page.tsx`: Solar/HP stepper.\n- `dashboard/page.tsx`: Home list.\n- No HA integration.\n- Supabase used for caching/tariffs/homes.\n\n## Section 1: Quick Wins (can implement this week)\n\n### Expand ROI calculator with more ECMs\n**Files:** `src/lib/roi-calculator.ts`, `src/app/roi/page.tsx`\n- Extend `SystemType += | 'led' | 'smart_thermostat' | 'draught_proofing' | 'cylinder_insulation' | 'double_glazing'`\n- New functions:\n  ```ts\n  async function calculateLEDPayback(postcode: string): Promise&lt;PaybackData&gt; {\n    const rates = await getStandardVariableRates(postcode);\n    const savings_kwh = 500; // 5x100W → LED equiv\n    const annualSavings = savings_kwh * calculateAverageRate(rates.unitRates);\n    return { systemType: 'led', paybackYears: 1200 / annualSavings, ... };\n  }\n  ```\n  Similar for others (costs: LED£200, draught£300, cylinder£100, thermostat£150, glazing£500/m² * area).\n- General `getAllECMs(postcode: string): ECM[]` where `interface ECM extends PaybackData { description: string; }`\n- Update ROI page: grid of all ECMs, not stepper.\n\n### Add EUI benchmarking to energy score\n**Files:** `src/lib/energy-calc.ts`, `src/app/score/ScoreResults.tsx`\n- In `EnhancedEnergyResults += { eui_kwh_m2: number; benchmark_median: number; vs_median_percent: number; }`\n  ```ts\n  const total_kwh = Object.values(results.energy_requirements).reduce((sum, r) =&gt; sum + (r?.quantity || 0), 0);\n  results.eui_kwh_m2 = total_kwh / buildingData.floors[Object.keys(buildingData.floors)[0]].area; // or TFA\n  const benchmarks = { 'detached': 250, 'semi-detached': 200, 'terraced': 180, 'flat': 150 };\n  results.benchmark_median = benchmarks[epc.property_type?.toLowerCase() as keyof typeof benchmarks] || 200;\n  ```\n- ScoreResults: new card `EUI: ${eui.toFixed(0)} kWh/m² (${vs_median_percent > 0 ? 'above' : 'below'} median by ${Math.abs(vs_median_percent).toFixed(0)}%)`\n\n### Add phased roadmap to score results\n**Files:** `src/lib/energy-calc.ts`, new `src/app/score/Roadmap.tsx`, `ScoreResults.tsx`\n- Group `upgrade_recommendations` by payback:\n  ```ts\n  const phases = {\n    phase1: upgrades.filter(u =&gt; u.payback_years &lt; 1),\n    phase2: upgrades.filter(u =&gt; u.payback_years &lt;= 3),\n    phase3: upgrades.filter(u =&gt; u.payback_years &lt;= 7)\n  };\n  ```\n- New component: Accordion with phases, list ECMs w/ savings/payback.\n- Add to ScoreResults after heat loss.\n\n## Section 2: Medium Term (2-4 weeks)\n\n### Home Assistant integration flow\n**New files:** `src/lib/home-assistant.ts`, `src/app/api/ha/connect/route.ts`, `src/app/api/ha/sensors/route.ts`\n- `home-assistant.ts`: `async validateConfig(token: string)` (fetch /config), `getEnergySensors(token)` → parse entities for power sensors.\n- DB table `ha_connections`: `{user_id, access_token (encrypted), last_sync}`\n- `/api/ha/connect`: POST `{code}`, exchange for token, store.\n- `/api/ha/analysis`: GET → fetch sensors 24h data → top_consumers: [{entity_id, kwh, %total}]\n- UI: Dashboard → 'Connect HA' button → modal → score gains HA tab w/ device recs (off-peak shift).\n\n### Enhanced financial modeling\n**Files:** `src/lib/roi-calculator.ts`\n- Add `calculateIRR(initial: number, annualSavings: number[], escalationRate=0.03, lifetime=25): number`\n  ```ts\n  // Newton-Raphson IRR or simple approx\n  ```\n- `lifecycleCost`, `netPresentValue`.\n- Update PaybackData += `{irr: number, npv: number, escalatedSavings: number[]}`\n\n### Grant mapper\n**New:** `src/lib/grants.ts`, extend ECM\n- `const ECM_GRANTS = { wall_insulation: [{name:'GBIS', est:2000, url:'...'}], ... }`\n- In `generateUpgradeRecommendations`: `upgrade.grants = ECM_GRANTS[upgrade.type] || []`\n- ScoreResults: grants section per phase.\n\n## Section 3: Future Features (product roadmap)\n\n- **Smart home automation drafts**: HA analysis → YAML automations (e.g., dishwasher off-peak if tariff high).\n- **Real-time energy monitoring dashboard**: HA websocket → live kWh chart in dashboard/home/[id].\n- **Device-level breakdown**: HA sensors → pie chart top consumers, idle recommendations.\n- **Comfort constraint engine**: User prefs (supabase `user_preferences: {min_temp:18, excluded: ['fridge']}`) → filter recs, intake form.\n\n## Section 4: Architecture Notes\n\n### New libs/types/interfaces\n- `npm i financial` or pure JS IRR.\n- `interface ECM { type: string; payback_years: number; phase: 1|2|3; grants: Grant[]; }`\n- `interface HAConnection { ... }`, `interface EnergySensor { entity_id: string; unit: 'kWh'; }`\n\n### Database schema additions (Supabase)\n```sql\nCREATE TABLE ha_connections (\n  id uuid PRIMARY KEY,\n  user_id uuid REFERENCES auth.users,\n  access_token text,\n  refresh_token text,\n  entities jsonb,\n  last_sync timestamptz\n);\n\nCREATE TABLE user_preferences (\n  user_id uuid PRIMARY KEY REFERENCES auth.users,\n  comfort_temp numeric,\n  savings_target numeric,\n  excluded_devices text[]\n);\n```\n\n### API routes to add\n- `GET /api/ecms?postcode=...` → all ECMs\n- `POST /api/ha/connect {code}`\n- `GET /api/ha/sensors`\n- `GET /api/grants?ecm=...`\n\n### Component hierarchy\n```\nScoreResults.tsx\n├── HeatLossChart\n├── SolarCard\n├── EUICard &lt;-- new\n├── PhasedRoadmap (Accordion)\n│   ├── Phase1\n│   └── ...\n├── GrantsList\n└── HAIntegrationButton &lt;-- new\nDashboard\n├── HomeCard\n│   └── HAStatusBadge\n└── ConnectHAButton\nROI\n└── ECMGrid\n```\n