<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evolving Home Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Evolving Home Live Dashboard</h1>
  <div id="overall-progress" class="overall-progress">
    <h2>Overall Roadmap Progress</h2>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <span id="progress-text"></span>
  </div>
  <div class="grid">
    <div class="card" id="overview">
      <h2>Project Overview</h2>
      <div id="overview-content">Loading...</div>
    </div>
    <div class="card" id="health">
      <h2>Integration Health</h2>
      <div id="health-content">Loading...</div>
    </div>
    <div class="card" id="waitlist">
      <h2>Waitlist Details</h2>
      <div id="waitlist-content">Loading...</div>
    </div>
    <div class="card" id="epc-stats">
      <h2>EPC Database Stats</h2>
      <div id="epc-stats-content">Loading...</div>
    </div>
    <div class="card" id="pipeline">
      <h2>Data Pipeline Status</h2>
      <div id="pipeline-content">Loading...</div>
    </div>
    <div class="card" id="codebase">
      <h2>Codebase Stats</h2>
      <div id="codebase-content">Loading...</div>
    </div>
    <div class="card" id="checklist">
      <h2>Roadmap Phases</h2>
      <div id="checklist-content">Loading...</div>
    </div>
    <div class="card" id="building-intelligence">
      <h2>Building Intelligence</h2>
      <div id="building-intelligence-content">Loading...</div>
    </div>
  </div>
  <script>
    async function updateSection(id, url) {
      try {
        const res = await fetch(url);
        const data = await res.json();
        let html = '';
        if (id === 'overview') {
          html = `
            <ul>
              <li>EPC Records: ${data.epcRecords}</li>
              <li>Waitlist Signups: ${data.waitlistSignups.total} (Recent: ${data.waitlistSignups.recent.length})</li>
              <li>Research Docs: ${data.researchDocs}</li>
              <li>Domain Status: ${data.domainStatus}</li>
              <li>Git Status: <pre>${data.gitStatus.join('\n')}</pre></li>
            </ul>
          `;
        } else if (id === 'health') {
          html = `<ul>${Object.entries(data).map(([k, v]) => `<li>${k}: ${v}</li>`).join('')}</ul>`;
        } else if (id === 'waitlist') {
          if (data.error) {
            html = `<p>${data.error}</p>`;
          } else {
            html = `
              <ul>
                <li>Total: ${data.total}</li>
                <li>By Country: ${JSON.stringify(data.byCountry)}</li>
                <li>Recent: <ul>${data.recent.map(r => `<li>${r.email} (${r.country}) - ${new Date(r.created_at).toLocaleDateString()}</li>`).join('')}</ul></li>
                <li>Daily Trend: ${JSON.stringify(data.dailyTrend)}</li>
              </ul>
            `;
          }
        } else if (id === 'epc-stats') {
          html = `
            <ul>
              <li>Total Records: ${data.total}</li>
              <li>By Rating: ${Object.entries(data.byRating).map(([r, c]) => `${r}: ${c}`).join(', ')}</li>
              <li>Top Regions: <ul>${data.byRegion.map(r => `<li>${r.local_authority}: ${r.count}</li>`).join('')}</ul></li>
            </ul>
          `;
        } else if (id === 'pipeline') {
          html = `<ul>${Object.entries(data).map(([k, v]) => `<li>${k}: ${v}</li>`).join('')}</ul>`;
        } else if (id === 'codebase') {
          html = `
            <p>Files: ${data.files}</p>
            <p>Lines: ${data.lines}</p>
            <p>Last Modified: <ul>${data.lastModified.map(f => `<li>${f}</li>`).join('')}</ul></p>
          `;
        } else if (id === 'checklist') {
          const { phases, overallProgress } = data;
          // Set overall progress
          const percentage = Math.round((overallProgress.completed / overallProgress.total) * 100);
          document.getElementById('progress-fill').style.width = `${percentage}%`;
          document.getElementById('progress-text').textContent = `${overallProgress.completed}/${overallProgress.total} tasks completed (${percentage}%)`;
          // Render phases
          html = phases.map(phase => {
            const statusIcon = phase.status === 'complete' ? 'üü¢' : phase.status === 'in-progress' ? 'üü°' : 'üî¥';
            const percentage = Math.round((phase.progress.completed / phase.progress.total) * 100);
            return `
              <div class="phase-card" onclick="togglePhase(this)">
                <div class="phase-header">
                  <h3>${phase.name}</h3>
                  <span class="status">${statusIcon} ${phase.status.replace('-', ' ')}</span>
                  <div class="progress-bar small">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                  </div>
                  <span class="progress-text">${phase.progress.completed}/${phase.progress.total}</span>
                </div>
                <div class="phase-details">
                  ${phase.tasks.map(task => `<p>${task.done ? '‚úÖ' : '‚ùå'} ${task.task}</p>`).join('')}
                </div>
              </div>
            `;
          }).join('');
        } else if (id === 'building-intelligence') {
          html = `
            <p>Status: ${data.osmBuildingGeometry}</p>
            <p>${data.description}</p>
            <ul>${data.features.map(f => `<li>${f}</li>`).join('')}</ul>
          `;
        }
        document.getElementById(`${id}-content`).innerHTML = html;
      } catch (e) {
        document.getElementById(`${id}-content`).innerHTML = `<p>Error: ${e.message}</p>`;
      }
    }

    function updateAll() {
      updateSection('overview', '/api/overview');
      updateSection('health', '/api/health');
      updateSection('waitlist', '/api/waitlist');
      updateSection('epc-stats', '/api/epc-stats');
      updateSection('pipeline', '/api/pipeline');
      updateSection('codebase', '/api/codebase');
      updateSection('checklist', '/api/checklist');
      updateSection('building-intelligence', '/api/building-intelligence');
    }

    function togglePhase(element) {
      const details = element.querySelector('.phase-details');
      details.classList.toggle('open');
    }

    updateAll();
    setInterval(updateAll, 30000);
  </script>
</body>
</html>